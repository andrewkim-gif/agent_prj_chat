<!DOCTYPE html>
<html>
<head>
    <title>Extension vs SDK Debug - Testnet Data Issue</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .method { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>🔍 Extension vs SDK Debug - Testnet Data Issue Analysis</h1>

    <div class="section">
        <h3>🎯 Investigation Purpose</h3>
        <p>Check why testnet shows mainnet data ("447 dollars", "tcross 1899") by comparing:</p>
        <ul>
            <li>✅ Direct Cross Wallet Extension API (<code>window.cross</code>)</li>
            <li>🔄 Cross SDK API (when available)</li>
            <li>🔍 Network-specific token data differences</li>
        </ul>
    </div>

    <div class="section">
        <h3>🔍 Real-time System Status</h3>
        <div id="status">Checking...</div>
        <button onclick="refreshStatus()" style="margin: 10px 0; padding: 8px 16px;">🔄 Refresh Status</button>
    </div>

    <div class="section comparison">
        <div class="method">
            <h4>🧩 Method 1: Direct Extension API</h4>
            <div id="extension-results"></div>
            <button onclick="testExtensionAPI()" style="margin: 10px 0; padding: 8px 16px;">🧪 Test Extension API</button>
        </div>

        <div class="method">
            <h4>⚡ Method 2: Cross SDK API</h4>
            <div id="sdk-results"></div>
            <button onclick="testSDKAPI()" style="margin: 10px 0; padding: 8px 16px;">🧪 Test SDK API</button>
        </div>
    </div>

    <div class="section">
        <h3>🌐 Network Switching Tests</h3>
        <button onclick="testMainnetData()" style="margin: 5px; padding: 8px 16px;">📊 Get Mainnet Data</button>
        <button onclick="testTestnetData()" style="margin: 5px; padding: 8px 16px;">🧪 Get Testnet Data</button>
        <button onclick="compareNetworkData()" style="margin: 5px; padding: 8px 16px;">⚖️ Compare Both Networks</button>
    </div>

    <div class="section">
        <h3>📋 Test Results & Analysis</h3>
        <div id="results"></div>
        <button onclick="clearResults()" style="margin: 10px 0; padding: 8px 16px;">🗑️ Clear Results</button>
    </div>

    <script>
        function log(message, type = 'info') {
            console.log(message);
            const div = document.getElementById('results');
            const p = document.createElement('p');
            p.className = type;
            p.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            div.appendChild(p);
            div.scrollTop = div.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function refreshStatus() {
            const statusDiv = document.getElementById('status');
            let html = '<h4>🔍 Current System Status:</h4>';

            // 1. Cross Wallet Extension Check
            if (window.cross) {
                try {
                    const chainId = await window.cross.getChainId();
                    const networkName = chainId === 4158 ? 'Testnet' : chainId === 4157 ? 'Mainnet' : 'Unknown';
                    html += `<div class="success">✅ Extension: Available (${networkName} - ChainID: ${chainId})</div>`;
                } catch (error) {
                    html += '<div class="error">❌ Extension: Error getting network info</div>';
                }
            } else {
                html += '<div class="error">❌ Extension: Not available</div>';
            }

            // 2. Cross SDK Check
            if (window.crossSdkReady) {
                html += `<div class="success">✅ Cross SDK: Ready (Network: ${window.crossSdkNetwork || 'unknown'})</div>`;
            } else {
                html += '<div class="warning">⚠️ Cross SDK: Not ready</div>';
            }

            // 3. ARA Chat Network Store Check
            if (window.useNetworkStore) {
                const state = window.useNetworkStore.getState();
                const network = state.currentNetwork;
                html += `<div class="info">ℹ️ ARA Chat: Current Network = ${network}</div>`;
            } else {
                html += '<div class="error">❌ ARA Chat: Network store not available</div>';
            }

            statusDiv.innerHTML = html;
        }

        async function testExtensionAPI() {
            const resultDiv = document.getElementById('extension-results');
            log('🧩 Testing Direct Extension API...', 'info');

            if (!window.cross) {
                resultDiv.innerHTML = '<div class="error">❌ Extension not available</div>';
                log('❌ Extension not available for testing', 'error');
                return;
            }

            try {
                // Get current network info
                const chainId = await window.cross.getChainId();
                const networkName = chainId === 4158 ? 'Testnet' : chainId === 4157 ? 'Mainnet' : 'Unknown';

                log(`📊 Extension - Current Network: ${networkName} (ChainID: ${chainId})`, 'info');

                // Test token list
                const tokens = await window.cross.getTokenList();
                log(`📋 Extension - Tokens Found: ${tokens.length}`, 'success');

                let resultHTML = `<h5>📊 Extension API Results:</h5>`;
                resultHTML += `<div class="info">Network: ${networkName} (${chainId})</div>`;
                resultHTML += `<div class="success">Tokens: ${tokens.length} found</div>`;

                if (tokens.length > 0) {
                    resultHTML += `<h6>🔍 Sample Tokens (First 3):</h6>`;
                    tokens.slice(0, 3).forEach((token, index) => {
                        resultHTML += `<div style="margin: 5px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">`;
                        resultHTML += `<strong>${token.symbol}</strong> - ${token.name}<br>`;
                        resultHTML += `Address: ${token.address}<br>`;
                        resultHTML += `Decimals: ${token.decimals || 'N/A'}`;
                        resultHTML += `</div>`;

                        log(`🔍 Extension Token ${index + 1}: ${token.symbol} (${token.name}) - ${token.address}`, 'info');
                    });
                }

                // Test with explicit chainId parameters (if supported)
                try {
                    const testnetTokens = await window.cross.getTokenList({ chainId: 4158 });
                    const mainnetTokens = await window.cross.getTokenList({ chainId: 4157 });

                    resultHTML += `<div style="margin-top: 10px;">`;
                    resultHTML += `<div class="info">Testnet (4158): ${testnetTokens.length} tokens</div>`;
                    resultHTML += `<div class="info">Mainnet (4157): ${mainnetTokens.length} tokens</div>`;
                    resultHTML += `</div>`;

                    log(`📊 Extension - Testnet specific tokens: ${testnetTokens.length}`, 'success');
                    log(`📊 Extension - Mainnet specific tokens: ${mainnetTokens.length}`, 'success');

                    // Compare networks
                    if (testnetTokens.length !== mainnetTokens.length) {
                        log(`⚠️ Extension - Different token counts: Testnet(${testnetTokens.length}) vs Mainnet(${mainnetTokens.length})`, 'warning');
                    } else {
                        log(`❓ Extension - Same token count on both networks - this might be the issue!`, 'warning');
                    }

                } catch (paramError) {
                    resultHTML += `<div class="warning">⚠️ ChainId parameters not supported</div>`;
                    log(`⚠️ Extension - ChainId parameters not supported: ${paramError.message}`, 'warning');
                }

                resultDiv.innerHTML = resultHTML;

            } catch (error) {
                const errorHTML = `<div class="error">❌ Extension API test failed: ${error.message}</div>`;
                resultDiv.innerHTML = errorHTML;
                log(`❌ Extension API test failed: ${error.message}`, 'error');
            }
        }

        async function testSDKAPI() {
            const resultDiv = document.getElementById('sdk-results');
            log('⚡ Testing Cross SDK API...', 'info');

            if (!window.crossSdkReady) {
                resultDiv.innerHTML = '<div class="warning">⚠️ SDK not ready</div>';
                log('⚠️ SDK not ready for testing', 'warning');
                return;
            }

            try {
                // Since SDK is wrapper around extension, this might use same data
                resultDiv.innerHTML = '<div class="info">ℹ️ SDK is ready but requires specific API tests</div>';
                log('ℹ️ SDK is ready - would need specific SDK API calls to test', 'info');

            } catch (error) {
                const errorHTML = `<div class="error">❌ SDK API test failed: ${error.message}</div>`;
                resultDiv.innerHTML = errorHTML;
                log(`❌ SDK API test failed: ${error.message}`, 'error');
            }
        }

        async function testMainnetData() {
            log('📊 Testing Mainnet Data...', 'info');

            if (!window.cross) {
                log('❌ Cannot test - Extension not available', 'error');
                return;
            }

            try {
                // Try to switch to mainnet
                if (typeof window.cross.switchChain === 'function') {
                    await window.cross.switchChain(4157);
                    log('🔄 Switched to Mainnet (4157)', 'info');

                    // Wait for switch
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // Get mainnet data
                const chainId = await window.cross.getChainId();
                const tokens = await window.cross.getTokenList();

                log(`📊 Mainnet Data - ChainID: ${chainId}, Tokens: ${tokens.length}`, 'success');

                if (tokens.length > 0) {
                    const sampleToken = tokens[0];
                    log(`🔍 Mainnet Sample Token: ${sampleToken.symbol} - ${sampleToken.name}`, 'info');
                }

            } catch (error) {
                log(`❌ Mainnet test failed: ${error.message}`, 'error');
            }
        }

        async function testTestnetData() {
            log('🧪 Testing Testnet Data...', 'info');

            if (!window.cross) {
                log('❌ Cannot test - Extension not available', 'error');
                return;
            }

            try {
                // Try to switch to testnet
                if (typeof window.cross.switchChain === 'function') {
                    await window.cross.switchChain(4158);
                    log('🔄 Switched to Testnet (4158)', 'info');

                    // Wait for switch
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // Get testnet data
                const chainId = await window.cross.getChainId();
                const tokens = await window.cross.getTokenList();

                log(`🧪 Testnet Data - ChainID: ${chainId}, Tokens: ${tokens.length}`, 'success');

                if (tokens.length > 0) {
                    const sampleToken = tokens[0];
                    log(`🔍 Testnet Sample Token: ${sampleToken.symbol} - ${sampleToken.name}`, 'info');
                }

            } catch (error) {
                log(`❌ Testnet test failed: ${error.message}`, 'error');
            }
        }

        async function compareNetworkData() {
            log('⚖️ Comparing Network Data...', 'info');

            if (!window.cross) {
                log('❌ Cannot compare - Extension not available', 'error');
                return;
            }

            try {
                // Test mainnet
                log('📊 Getting Mainnet data...', 'info');
                if (typeof window.cross.switchChain === 'function') {
                    await window.cross.switchChain(4157);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                const mainnetChainId = await window.cross.getChainId();
                const mainnetTokens = await window.cross.getTokenList();

                log(`📊 Mainnet: ChainID ${mainnetChainId}, ${mainnetTokens.length} tokens`, 'success');

                // Test testnet
                log('🧪 Getting Testnet data...', 'info');
                if (typeof window.cross.switchChain === 'function') {
                    await window.cross.switchChain(4158);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                const testnetChainId = await window.cross.getChainId();
                const testnetTokens = await window.cross.getTokenList();

                log(`🧪 Testnet: ChainID ${testnetChainId}, ${testnetTokens.length} tokens`, 'success');

                // Compare results
                log('⚖️ COMPARISON RESULTS:', 'info');
                log(`📊 Mainnet: ${mainnetTokens.length} tokens`, 'info');
                log(`🧪 Testnet: ${testnetTokens.length} tokens`, 'info');

                if (mainnetTokens.length === testnetTokens.length) {
                    log('🚨 POTENTIAL ISSUE: Same token count on both networks!', 'warning');
                    log('💡 This could explain why testnet shows mainnet data', 'warning');
                } else {
                    log('✅ Different token counts - networks appear properly separated', 'success');
                }

                // Compare first few tokens
                if (mainnetTokens.length > 0 && testnetTokens.length > 0) {
                    const mainnetFirst = mainnetTokens[0];
                    const testnetFirst = testnetTokens[0];

                    log(`📊 Mainnet first token: ${mainnetFirst.symbol} - ${mainnetFirst.name}`, 'info');
                    log(`🧪 Testnet first token: ${testnetFirst.symbol} - ${testnetFirst.name}`, 'info');

                    if (mainnetFirst.symbol === testnetFirst.symbol && mainnetFirst.address === testnetFirst.address) {
                        log('🚨 ISSUE CONFIRMED: Same tokens on both networks!', 'error');
                    } else {
                        log('✅ Different tokens - network separation working', 'success');
                    }
                }

            } catch (error) {
                log(`❌ Network comparison failed: ${error.message}`, 'error');
            }
        }

        // Auto-run status check on load
        window.addEventListener('load', () => {
            setTimeout(refreshStatus, 1000);
        });

        // Auto-refresh status every 15 seconds
        setInterval(refreshStatus, 15000);
    </script>
</body>
</html>